import { WebSocketServer } from "ws";
import fetch from "node-fetch";
import fs from "fs";
import path from "path";

export function setupRealtimeServer(server: any, log: Function) {
  const wss = new WebSocketServer({ server, path: "/realtime" });
  log("ðŸ”Š WebSocket Realtime channel initialized", "ws");

  // Load voice map
  const voiceMapPath = path.join(process.cwd(), "server", "config", "voiceMap.json");
  const voiceMap = JSON.parse(fs.readFileSync(voiceMapPath, "utf-8"));

  wss.on("connection", (ws) => {
    ws.on("message", async (msg) => {
      const { from, free_text } = JSON.parse(msg.toString());
      const OPENAI_KEY = process.env.OPENAI_API_KEY!;
      const ELEVEN_KEY = process.env.ELEVENLABS_API_KEY!;

      const VOICE_ID =
        voiceMap[from] || process.env.MRF_VOICE_ID || voiceMap["default"];

      try {
        // 1. Stream text from GPT
        const gptRes = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            Authorization: `Bearer ${OPENAI_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: "gpt-4o-mini",
            stream: true,
            messages: [
              {
                role: "system",
                content:
                  "You are an Arabic speaking assistant with a natural tone."
              },
              { role: "user", content: free_text }
            ]
          })
        });

        const reader = gptRes.body!.getReader();
        let fullText = "";

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          const chunk = new TextDecoder().decode(value);
          const match = chunk.match(/"content":"([^"]+)"/);
          if (match) {
            const word = match[1];
            fullText += word;
            ws.send(JSON.stringify({ type: "text", data: word }));

            // Send partial audio from ElevenLabs
            const voiceRes = await fetch(
              `https://api.elevenlabs.io/v1/text-to-speech/${VOICE_ID}/stream`,
              {
                method: "POST",
                headers: {
                  "xi-api-key": ELEVEN_KEY,
                  Accept: "audio/mpeg",
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({ text: word })
              }
            );

            if (voiceRes.ok) {
              const audioChunk = Buffer.from(await voiceRes.arrayBuffer());
              ws.send(JSON.stringify({
                type: "audio",
                data: audioChunk.toString("base64")
              }));
            }
          }
        }

        ws.send(JSON.stringify({ type: "end", data: fullText }));
      } catch (e: any) {
        ws.send(JSON.stringify({ type: "error", message: e.message }));
      }
    });
  });
}